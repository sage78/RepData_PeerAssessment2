---
title: "Severe weather event consequence report"
output: 
  html_document:
    keep_md: true
--- 

## Synopsis

Storms and other severe weather events can cause both public health and 
economic problems for communities and municipalities. This report is 
based on U.S. National Oceanic and Atmospheric Administration's (NOAA) 
storm database and it lists weather events with most harmful effects on
population health and ones with greatest economic consequences 
accross United States. Geographical variation has not been studied in this 
report.


## Data processing

Data is processes for analysis in the following way

- Set locale and load required libraries
- Download source data
- Read source data
- Transform data
- Calculate harmful effects on population health
- Resolve events with greatest economic consequences

Each of these steps are decribed in their own chapters below.

### Set locale and load required libraries

Locale is set to English and required libraries are loaded.

```{r settings}
Sys.setlocale("LC_TIME", "English")

library(ggplot2)
library(lubridate)
```

### Download source data

Source data is loaded if necessary. For this report, the data file was loaded
from http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2
at 12th Dec 2014 9:15 (GMT+3). The source data is in compressed bz2 format. 

```{r download, cache=TRUE}
if( !file.exists("repdata-data-StormData.csv.bz2")) {
  if( !file.exists("repdata-data-StormData.csv.bz2")) {
    download.file("http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", 
      	          "repdata-data-StormData.csv.bz2", 
      	          mode="wb")
	}
}
```

### Read source data

The data is in CSV-format and is read in.

National Weather Service provides some documentation about the source data, see
http://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf.

```{r readdata, cache=TRUE}
datafile <- bzfile("repdata-data-StormData.csv.bz2", "r")
data <- read.csv(datafile)
close(datafile)
```

The events in the database start in the year 1950 and end in November 2011. 
There are `r nrow(data)` rows in the dataset.

### Transform data

BGN_DATE column containing start date of the event. A new column YEAR is added
for indicating starting year of each event.

```{r transformdata}
data$YEAR <- as.numeric(gsub("^[0-9]+/[0-9]+/([0-9]+).*$","\\1", 
                             as.character(data$BGN_DATE)))
```

Tabel below lists total amount of events through years. 

```{r eventsperyear}
table(data$YEAR)
```
In the earlier years of the database there are generally fewer events 
recorded, most likely due to a lack of good records. In our analysis, 
we use only data from 1995 onwards to overcome the issues caused by
varying data quality.

```{r subsetdata}
data <- subset(data, data$YEAR >= 1995)
```

### Calculate harmful effects on population health

Harmful effects for population health are fatalities and injuries. Top 10
event types causing both fatalities and injuries are resolved.

```{r harmfulevents}
fatalities <- aggregate(data$FATALITIES, 
                        by=list(evtype=data$EVTYPE), 
                        FUN=sum)
fatalities <- fatalities[order(-fatalities$x), ]
fatalities <- fatalities[1:10,]
fatalities$evtype = with(fatalities, reorder(evtype, 10:1))

injuries <- aggregate(data$INJURIES, 
                      by=list(evtype=data$EVTYPE), 
                      FUN=sum)
injuries <- injuries[order(-injuries$x), ]
injuries <- injuries[1:10,]
injuries$evtype = with(injuries, reorder(evtype, 10:1))
```

### Resolve events with greatest economic consequences

Events with greatest economic consequences are resolved. Events cause
both crop and property damages, so damages are summed up.

In addition, each DMG column contains a numeric value and each 
DMGEXP column containg thousand multipliers for the numeric values. These
are converted into a numeric format.

```{r damages}
# combine PROPDMG and PROPDMGEXP
data$PROPDMGNUMBERS <- mapply(data$PROPDMG, data$PROPDMGEXP, FUN = function(value, multiplier) {
  if(toupper(multiplier) == "K") value * 1000
  else if(toupper(multiplier) == "M") value * 1000000
  else if(toupper(multiplier) == "B") value * 1000000000
  else value
}) 

# combine CROPDMG and CROPDMGEXP
data$CROPDMGNUMBERS <- mapply(data$CROPDMG, data$CROPDMGEXP, FUN = function(value, multiplier) {
  if(toupper(multiplier) == "K") value * 1000
  else if(toupper(multiplier) == "M") value * 1000000
  else if(toupper(multiplier) == "B") value * 1000000000
  else value
}) 

# combine PROP and CROP damages
damages <- aggregate(data$PROPDMGNUMBERS + data$CROPDMGNUMBERS, 
    	   by=list(evtype=data$EVTYPE), 
			   FUN=sum)
damages <- damages[order(-damages$x), ]
damages <- damages[1:10,]
damages$evtype = with(damages, reorder(evtype, 10:1))
```


## Results

The results are presented below in bar charts.

### Total fatalities by event type

Chart below decribes 10 event types with highest fatality numbers between 
1995-2011 accross United States.

```{r fatalityplot}
ggplot(fatalities, 
       aes(x = evtype, y = x)) +     
       xlab("Event types") +
       ylab("Fatalities") + 
       geom_bar(stat = "identity") + 
       coord_flip()
```

### Total injuries by event type

Chart below decribes 10 event types with highest injury numbers between 
1995-2011 accross United States

```{r injuryplot}
ggplot(injuries, 
       aes(x = evtype, y = x)) +     
       xlab("Event types") +
       ylab("Injuries") + 
       geom_bar(stat = "identity") + 
       coord_flip()
```

### Total damages by event type

Chart below decribes 10 event types with highest caused damages between 
1995-2011 accross United States

```{r damageplot}
ggplot(damages, 
       aes(x = evtype, y = x)) +     
       xlab("Event types") +
       ylab("Damages ($)") + 
       geom_bar(stat = "identity") + 
       coord_flip()
```